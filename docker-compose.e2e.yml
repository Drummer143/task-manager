name: task-manager-e2e

services:
    postgres:
        image: postgres:16-alpine
        container_name: postgres-e2e
        healthcheck:
            test: ["CMD", "pg_isready", "-U", "postgres"]
            interval: 5s
            timeout: 3s
            retries: 5
        deploy:
            resources:
                limits:
                    memory: 128M
                    cpus: "0.25"
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: postgres
        ports:
            - 5432:5432
        networks:
            - e2e-net
        tmpfs:
            - /var/lib/postgresql/data

    postgres-init:
        image: postgres:16-alpine
        container_name: postgres-init-e2e
        depends_on:
            postgres:
                condition: service_healthy
        networks:
            - e2e-net
        environment:
            PGPASSWORD: postgres
        command: >
            bash -c "
            echo 'Creating uuid-ossp extension...';
            psql -h postgres -U postgres -d postgres -c 'CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";';

            echo 'Check if authentik user exists...';
            psql -h postgres -U postgres -d postgres -tAc \"SELECT 1 FROM pg_roles WHERE rolname='authentik'\" | grep -q 1 || \
            psql -h postgres -U postgres -d postgres -c \"CREATE USER authentik WITH PASSWORD 'authentik';\";

            echo 'Check if authentik database exists...';
            psql -h postgres -U postgres -d postgres -tAc \"SELECT 1 FROM pg_database WHERE datname='authentik'\" | grep -q 1 || \
            psql -h postgres -U postgres -d postgres -c \"CREATE DATABASE authentik OWNER authentik;\";

            echo 'Granting privileges...';
            psql -h postgres -U postgres -d postgres -c \"GRANT ALL PRIVILEGES ON DATABASE authentik TO authentik;\";

            echo 'DB init complete';
            "

    redis:
        image: redis:alpine
        container_name: redis-e2e
        command: ["redis-server", "--appendonly", "no"]
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 5s
            timeout: 3s
            retries: 5
        deploy:
            resources:
                limits:
                    memory: 64M
                    cpus: "0.1"
        ports:
            - 6379:6379
        networks:
            - e2e-net

    rmq:
        image: rabbitmq:management-alpine
        container_name: rmq-e2e
        healthcheck:
            test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
            interval: 10s
            timeout: 5s
            retries: 10
            start_period: 15s
            start_interval: 10s
        deploy:
            resources:
                limits:
                    memory: 192M
                    cpus: "0.25"
        environment:
            RABBITMQ_DEFAULT_USER: guest
            RABBITMQ_DEFAULT_PASS: guest
        ports:
            - 5672:5672
            - 15672:15672
        networks:
            - e2e-net

    authentik_server:
        image: ghcr.io/goauthentik/server:2025.2.4
        container_name: authentik-server-e2e
        command: server
        deploy:
            resources:
                limits:
                    memory: 768M
                    cpus: "0.5"
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    'python3 -c ''import urllib.request; urllib.request.urlopen("http://localhost:9000/-/health/live/")''',
                ]
            interval: 10s
            timeout: 5s
            retries: 10
            start_period: 30s
        environment:
            AUTHENTIK_REDIS__DB: 0
            AUTHENTIK_REDIS__HOST: redis
            AUTHENTIK_SECRET_KEY: e2e-test-secret-key-not-for-production
            AUTHENTIK_POSTGRESQL__HOST: postgres
            AUTHENTIK_POSTGRESQL__USER: authentik
            AUTHENTIK_POSTGRESQL__NAME: authentik
            AUTHENTIK_POSTGRESQL__PASSWORD: authentik
            AUTHENTIK_BOOTSTRAP_PASSWORD: admin
            AUTHENTIK_BOOTSTRAP_EMAIL: admin@test.local
            AUTHENTIK_BOOTSTRAP_TOKEN: e2e-bootstrap-token
            AUTHENTIK_LOG_LEVEL: warning
        ports:
            - "9000:9000"
            - "9443:9443"
        depends_on:
            postgres-init:
                condition: service_completed_successfully
            redis:
                condition: service_healthy
        volumes:
            - ./authentik/media:/media
            - ./authentik/custom-templates:/templates
            - ./authentik/blueprints:/blueprints
        networks:
            - e2e-net

    authentik_worker:
        image: ghcr.io/goauthentik/server:2025.2.4
        container_name: authentik-worker-e2e
        command: worker
        deploy:
            resources:
                limits:
                    memory: 512M
                    cpus: "0.5"
        environment:
            AUTHENTIK_REDIS__DB: 0
            AUTHENTIK_REDIS__HOST: redis
            AUTHENTIK_SECRET_KEY: e2e-test-secret-key-not-for-production
            AUTHENTIK_POSTGRESQL__HOST: postgres
            AUTHENTIK_POSTGRESQL__USER: authentik
            AUTHENTIK_POSTGRESQL__NAME: authentik
            AUTHENTIK_POSTGRESQL__PASSWORD: authentik
            AUTHENTIK_LOG_LEVEL: warning
        depends_on:
            postgres-init:
                condition: service_completed_successfully
            redis:
                condition: service_healthy
        volumes:
            - ./authentik/blueprints:/blueprints/custom
        networks:
            - e2e-net

    main-service:
        container_name: main-service-e2e
        image: main-service:e2e
        restart: on-failure:5
        ports:
            - 8080:8080
        depends_on:
            postgres:
                condition: service_healthy
            authentik_server:
                condition: service_healthy
            authentik_worker:
                condition: service_started
        deploy:
            resources:
                limits:
                    memory: 96M
                    cpus: "0.25"
        build:
            context: .
            dockerfile: Dockerfile.backend-rust
            args:
                APP_NAME: main
                PROFILE: dev
                TARGET_DIR: debug
        environment:
            DATABASE_URL: postgres://postgres:postgres@postgres:5432/postgres
            PORT: 8080
            JWT_SECRET: e2e-jwt-secret
            RABBITMQ_URL: amqp://guest:guest@rmq:5672/%2f
            AUTHENTIK_JWKS_URL: http://host.docker.internal:9000/application/o/task-manager/jwks/
            AUTHENTIK_AUDIENCE: e2e-test-client
        networks:
            - e2e-net

    storage-service:
        container_name: storage-service-e2e
        image: storage-service:e2e
        ports:
            - 8082:8082
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        deploy:
            resources:
                limits:
                    memory: 128M
                    cpus: "0.25"
        build:
            context: .
            dockerfile: Dockerfile.backend-rust
            args:
                APP_NAME: storage
                PROFILE: dev
                TARGET_DIR: debug
        environment:
            JWT_SECRET: e2e-jwt-secret
            SELF_PORT: 8082
            SELF_HOST: localhost
            STATIC_FOLDER_PATH: /static
            DATABASE_URL: postgres://postgres:postgres@postgres:5432/postgres
            REDIS_URL: redis://redis:6379
            MAIN_SERVICE_URL: http://main-service:8080
            AUTHENTIK_JWKS_URL: http://host.docker.internal:9000/application/o/task-manager/jwks/
            AUTHENTIK_AUDIENCE: e2e-test-client
        networks:
            - e2e-net
        volumes:
            - storage-e2e:/static

    notifications-service:
        container_name: notifications-service-e2e
        image: notifications-service:e2e
        ports:
            - 8079:8079
        depends_on:
            rmq:
                condition: service_healthy
            authentik_server:
                condition: service_healthy
        deploy:
            resources:
                limits:
                    memory: 128M
                    cpus: "0.25"
        build:
            context: .
            dockerfile: Dockerfile.backend-elixir
            args:
                APP_NAME: notifications
        environment:
            PORT: 8079
            RABBITMQ_URL: amqp://guest:guest@rmq:5672/%2f
            DATABASE_URL: postgres://postgres:postgres@postgres:5432/postgres
            SECRET_KEY_BASE: e2e-secret-key-base-at-least-64-chars-long-for-phoenix-framework
            AUTHENTIK_ISSUER: http://host.docker.internal:9000/application/o/task-manager/
            AUTHENTIK_JWKS_URL: http://host.docker.internal:9000/application/o/task-manager/jwks/
            AUTHENTIK_AUDIENCE: e2e-test-client
        networks:
            - e2e-net

    chat-service:
        container_name: chat-service-e2e
        image: chat-service:e2e
        ports:
            - 8078:8078
        depends_on:
            postgres:
                condition: service_healthy
            authentik_server:
                condition: service_healthy
        deploy:
            resources:
                limits:
                    memory: 128M
                    cpus: "0.25"
        build:
            context: .
            dockerfile: Dockerfile.backend-elixir
            args:
                APP_NAME: chat
        environment:
            PORT: 8078
            DATABASE_URL: postgres://postgres:postgres@postgres:5432/postgres
            SECRET_KEY_BASE: e2e-secret-key-base-at-least-64-chars-long-for-phoenix-framework
            AUTHENTIK_ISSUER: http://host.docker.internal:9000/application/o/task-manager/
            AUTHENTIK_JWKS_URL: http://host.docker.internal:9000/application/o/task-manager/jwks/
            AUTHENTIK_AUDIENCE: e2e-test-client
        networks:
            - e2e-net

    task-manager:
        build:
            context: .
            dockerfile: Dockerfile.frontend
            args:
                APP_NAME: task-manager
        container_name: task-manager-e2e
        image: task-manager:e2e
        ports:
            - 1346:80
        deploy:
            resources:
                limits:
                    memory: 48M
                    cpus: "0.1"
        depends_on:
            - main-service
            - storage-service
            - notifications-service
            - chat-service
        networks:
            - e2e-net

    playwright:
        image: mcr.microsoft.com/playwright:v1.57.0-noble
        container_name: playwright-e2e
        user: root
        working_dir: /app
        volumes:
            - .:/app
            - playwright-node-modules:/app/node_modules
        deploy:
            resources:
                limits:
                    memory: 1G
                    cpus: "1"
        environment:
            BASE_URL: http://task-manager:80
            AUTHENTIK_URL: http://host.docker.internal:9000
            CI: "true"
        depends_on:
            - task-manager
            - authentik_server
        networks:
            - e2e-net
        command: >
            sh -c "
            npm install -g pnpm &&
            pnpm install &&
            pnpm exec playwright test --config=apps/frontend/task-manager/playwright.config.ts --project=chromium
            "

networks:
    e2e-net:

volumes:
    storage-e2e:
    playwright-node-modules:
